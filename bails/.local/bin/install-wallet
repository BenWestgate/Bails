#!/bin/bash

# Copyright (c) 2025 Ben Westgate
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
# THE SOFTWARE.

###############################################################################
# Download .deb wallet application from GitHub, install/update it persistently
###############################################################################


readonly DOTFILES='/live/persistence/TailsData_unlocked/dotfiles'
readonly PERSISTENT='/live/persistence/TailsData_unlocked/Persistent'
export LOCAL_DIR="$DOTFILES/.local"
readonly XDG_DATA_HOME=$LOCAL_DIR/share
readonly WRAPPER="Exec=wrapped "
readonly ICON="--window-icon=$XDG_DATA_HOME/icons/bails128.png"

case "$1" in

    liana)
    readonly SIGNING_KEY="4730DDCC64DFAEC16CEFEB5BE65F7A089C20DC8F"
    readonly GITHUB_REPO="wizardsardine/liana"
    ;;

    sparrow)
    readonly SIGNING_KEY="D4D0D3202FC06849A257B38DE94618334C674B40"
    readonly GITHUB_REPO="sparrowwallet/sparrow"
    ;;

    wasabi)
    readonly SIGNING_KEY="6FB3872B5D42292F59920797856348328949861E"
    readonly GITHUB_REPO="WalletWasabi/WalletWasabi"
    ;;

    *)
    exit 1
    ;;

esac

gpg --keyserver=keyserver.ubuntu.com --recv-keys $SIGNING_KEY & keys=$!
cd $DOTFILES/.cache/bails
wget --continue https://github.com/$GITHUB_REPO/releases/latest
ver=$(grep $GITHUB_REPO/releases/expanded_assets latest | cut -d'"' -f6)
wget -c -nd -r --reject=*server* --accept=*.deb{,.asc},*.txt{,.asc} $ver
wait -f $keys
signed_data=$(gpg --verify *.asc 2>&1) || exit 1
deb=$(echo $signed_data | awk -F"'" '{print $2}')
if [[ "$deb" =~ .txt ]]; then
    check=$(sha256sum --check --ignore-missing $deb) || exit 1
    deb=${check/:*}
fi
find ./* -type d -exec rm -rf {} \;
pkgname=$(dpkg-deb -f $deb Package) || exit 1
dpkg-deb -X $deb . || exit 1
bin_dir=$(find * -maxdepth 3 -type d -name "bin")
base_dir=${bin_dir%/*}
chmod -R 700 *
desktop=$(find * -type f -name *.desktop)
sed -i s,/$base_dir,$LOCAL_DIR,g $desktop
sed -i s,/opt/$pkgname,$XDG_DATA_HOME/$pkgname,g $desktop
sed "s,Exec=,$WRAPPER,g" $desktop > $XDG_DATA_HOME/applications/${desktop##*/}
rsync -r -a --remove-source-files $base_dir/* $LOCAL_DIR
[ -d usr ] && rsync -r -a --remove-source-files usr/* $LOCAL_DIR
[ -d opt ] && rsync -r -a --remove-source-files /opt/$pkgname/* $XDG_DATA_HOME/$pkgname
link-dotfiles
#install -D $desktop -t $XDG_DATA_HOME/applications
#install -D $(find * -name *MimeInfo.xml) -t $XDG_DATA_HOME/mime/packages

#xdg-desktop-menu $desktop
#xdg-mime $mime

gtk-launch ${desktop##*/}


