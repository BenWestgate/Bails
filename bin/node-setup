#!/bin/bash
########################################
# Installs Bails Persistently and helps memorize passphrase
########################################

timeout=5
SOURCE='/live/persistence/TailsData_unlocked/'

zenity --title='Welcome to Bails' --info --text="Your Bitcoin data will be encrypted with a passphrase for privacy and security.\n\n<b>Notes on Passphrases</b>\nSelect a passphrase as strong as you feel comfortable with.\nTails will recommend a long passphrase made of <b>five</b> to <b>seven random words</b>.\nIt is impossible to recover your passphrase if you forget it!

<b>What if you forget it?</b>  
You will make a codex32 seed backup on paper as a fallback to restore your wallet if your brain refuses to cooperate or you lose all your Bails USBs." --width=640 --ok-label=Continue --width=640 $ICON

# loop until luks device unlocks
until [ -b '/dev/mapper/TailsData_unlocked' ]; do
    pgrep zenity &>/dev/null || zenity --warning --title='Choose a strong passphrase' --text='Important: Use a suggested passphrase from the Persistent Storage dialog.\n\nTo help you remember your passphrase, write it on a piece of paper, store it in a sealed evelope in your wallet for a few days, and destroy it once you know it well. Write on a hard surface to avoid leaving an imprint of the secret.' --ok-label='I Will Use A Suggested Passphrase' --width=700 --window-icon=$BAILS_DIR/share/icons/bails128.png
    sleep 1
done &

# loop until persistent storage has mounted
until [ -d "$SOURCE" ]; do
    # restart tps if closed without creating persistence.
    grep --count 'python3 /usr/local/lib/tps-frontend' <<< $(ps -ef) - >/dev/null || { tps-frontend-wrapper & zenity --notification --text='Click Continue to create a Persistent Storage'; }
    sleep $((i++))
done
pkill zenity

# loop until a screen lock password is set
until { zenity --info --title='Spaced repetition trainer' --text='Important: Enter the <b>exact</b> same passphrase from Persistent Storage so Bails can help you memorize it.' --ok-label='I Will Enter the Exact Same Passphrase' --ellipsize $ICON;
    tails-screen-locker; }; do    
        zenity --warning --text='No passphrase was entered.' --title="Spaced repetition trainer" --ok-label='Try Again' --ellipsize $ICON
done

# spaced repetition training loop
while true; do
    sleep $((timeout *= 2))
    tails-screen-locker &>/dev/null
done &
zenity --info --title='Tips for the new passphrase' --text="You will be prompted periodically for the password throughout the remainder of this tutorial. If you forget it before a complete backup is created, you will have to start over.\n\nPractice entering this password regularly, daily at first and then at least once a week. Repetition will help you commit the password to memory." --ok-label='Continue' --width=600 $ICON
zenity --info --title='Keep your passphrase safe' --text="Make sure you keep your passphrase safe. Your passphrase should only be used for Bails, and especially should not be used for any online account. If you reuse a passphrase and it ends up being leaked, it can be used to try to access your funds or Bitcoin data.\n\nIf you wrote your passphrase down, don't store it with this Bails USB and destroy it as soon as you know it well." --ok-label='Continue' --width=600 $ICON

# loop until needed Persistent features are on
until /usr/local/lib/tpscli is-active PersistentDirectory && \
  /usr/local/lib/tpscli is-active GnuPG && \
  /usr/local/lib/tpscli is-active Dotfiles; do
    { /usr/local/lib/tpscli is-active PersistentDirectory || { zenity --notification --text='Persistent Folder must be turned on.' --timeout=6; false; }; } && \
    { /usr/local/lib/tpscli is-active NetworkConnections || { ((i++ < 3)) && zenity --notification --text='Turn on Network Connections to remember your Wi-Fi' --timeout=6; true; }; } && \
    { /usr/local/lib/tpscli is-active GnuPG || { zenity --notification --text='GnuPG must be turned on.' --timeout=6; false; }; } && \
    { /usr/local/lib/tpscli is-active Dotfiles || { zenity --notification --text='Dotfiles must be turned on.' --timeout=6; false; }; }
    # restart tps if closed before configured
    grep --count 'python3 /usr/local/lib/tps-frontend' <<< $(ps -ef) - >/dev/null || { tps-frontend-wrapper & zenity --notification --text='You must turn on Persistent features to continue'; }
done

# closes the Persistent Storage window
pkill python3 &>/dev/null

# install Bails executables, shortcuts and icons.
rsync --recursive $BAILS_DIR/{bin,lib,share,state} $LOCAL_DIR; link_dotfiles
